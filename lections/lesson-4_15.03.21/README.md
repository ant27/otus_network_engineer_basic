## Занятие 4. Сетевой уровень IP. 

Дата занятия: 15.03.21

###  Назначение сетевого уровня стека IP.

Сетевой уровень предоставляет услугу по обмену данными между конечными устройствами, находящимися как в одной, так и в разных сетях. Тогда как канальный уровень поддерживает связь только в одной сети.

На данный момент протокол IP (IPv4 и IPv6) практически вытеснил все остальные протоколы, среди которых IPX и Aplle Talk. Эти протоколы не следует путать с тоже практически не используемыми и вытеснеными ethernet'ом протоколами канального уровня - X25, Frame Relay, Token Ring, FDDI, ATM.

Сетевой уровень выполняет основные операции:

- Уникальная адресация конечных устройств (в протоколе сетевого уровня адреса всегда уникальны, за исключением NAT, о котором будет рассказано позже).
- Инкапсуляция - данные верхних уровней вкладываются в сетевой пакет со всеми их заголовками.
- Деинкапсуляция - процесс, обратный инкапсуляции
- Маршрутизация - передача данных из сети в сеть в соотвествии с правилами сетевых устройств.

Инкапсуляция:

- Использование протокола IP версий 4 и 6 никак не влияет на данные верхних уровней. 
- IP-пакет проверяется всеми устройствами уровня 3 по мере прохождения сети.
- IP-адресация не изменяется от источника к адресату (кроме случая NAT)

Особенности протокола IP:

- пакетная передача данных.
- Работает без установления соединения.
- Не гарантирована доставка:
 * не может воcстановить поврежденные пакеты
 * не может повторно передать поврежденные или недоставленные пакеты
 * не может восстановить последовательность пакетов
- Независимость от среды - может передаваться по любому типу носителей.
 * для осуществления независимости от среды передачи было введено понятие MTU - maximum transmission unit - максимальный блок передачи данных
 * Значение MTU сетевой уровень получает из управляющей информации канального уровня (максимальный размер кадра канального уровня)
 * Процесс сетевого уровня на узле указывает транспортному уровню (TCP, UDP), на какие сегменты делить поток данных, чтобы они входили по размеру в MTU.
 * При переходе из сети с большим MTU в сеть с меньшим MTU протокол IP предусматривает фрагментацию пакетов со сборкой их в узле назначения.
 * В данный момент фрагментация IP пакетов является нежелательной и часто запрещается провайдерами, так как используется стандартный размер MTU (для протокола Ethernet 1400 байт)

### Структура заголовка IPv4 пакета.

Заголовок состоит из 20 байт - 5 блоков по 4 байта.

Структура 1-го блока:
- Version + Internet header length (1 byte) - версия протокола IP (4 или 6) и длина заголовка.
- DS (1 byte) - поле QoS, идентификатор приоритета траффика
- Total Length (2 byte) - общая длина пакета

Структура 2-го блока (поля, отвечающие за фрагментацию):
- Identification (2 byte) - идентификационный номер
- Flag (1 byte) - флаг фрагментирования
- Fragment Offset (2 byte) - отступ

Структура 3-го блока:
- Time-To-live (1 byte) - время жизни кадра  (количество переходов)
- Protocol (1 byte) - код протокола вышестоящего уровня, инкапсулированного в IP пакет.
- Checksum (2 byte) - Контрольная сумма заголовка

Структура 3-го блока:
IP адрес узла источника (4 байта, 32 бита)

Структура 3-го блока:
IP адрес узла назначения (4 байта, 32 бита)

Ограничения протокола IPv4:
- Истощение адресов.
- Отсутствие в большинстве случаев прямого подключения между узлами и публичной адресации по причине использования NAT.
- Повышенная сложность сети из-за NAT.

### Обзор IPv6

- Увеличено адресное пространство - IPv6 адрес увеличен до 128 бит, что дало вместо 4 млд адресов в IPv4, 10^36 степени адресов.
- Упрощение заголовка IPV6
- Устранение необходимости NAT, которое повышает нагрузку на маршрутизаторы


### Структура заголовка IPv6 пакета.

Заголовок состоит из 40 байт

- Version - 4х битное поле со значением 0110 - 6 в десятичном формате.
- Traffic Class - качество обслуживания
- Flow Label - метка потока - узел назначает одинаковую метку потока всем пакетам, идущим по одному адресу, соотвестственно машрутизатора, разобрав один пакет, все остальные с такой же меткой обрабабатывает идентично. 
- Payload length - длина блока данных в пакете
- Next Header - идентификатор протокола следующего уровня (часть из них может быть обработано самим маршрутизатором)
- Hop Limit - лимит переходов 
- Source IP address
- Destination IP address

Поля заголовка, исключенные в IPv6 по сравнению с IPv4:
- Флаг фрагментации
- Смещение фрагмента
- Контрольная сумма заголовка.

Заголовки расширений (EH) - дополнительные необязательные заголовки, которые предоставляют дополнительную информацию о сетевом уровне и помещаются между IPV6 заголовком и блоком данных.

### Маршрутизация пакетов.

Порядок маршрутизации пакета узлом:
- Хост формирует IP пакет с полезными данными
- Хост сравнивает с помощью маски подсети сетевые части собственого IP адреса и назначения. Если они совпадают, то есть IP адрес назначения находится в той же сети, что и собственный адрес хоста, через протокол ARP (и таблицу соотвествия MAC адресов) определяется MAC адрес узла назначения, формируется кадр с MAC адресом узла назначения и отправляется в сеть.
- Если IP адрес назначения находится в другой сети, через протокол ARP (и таблицу соотвествия MAC адресов) и предварительно указанный в настройках интерфейса IP адрес шлюза определяется MAC адрес шлюза и формируется кадр с MAC адресом шлюза и отправляется в сеть.
- Если IP адрес узла назначения для IPv4 входит в диапазон 127.*.*.*, а для IPv6 адрес имеет вид ::1, это так называемы loopback, localhost адрес, пакет не уходит в сеть, а отправляется на вход интерфейса самого себя.

### Определение шлюза по умолчанию

- На хостах шлюз по умолчанию может настраиваться статически.
- На хостах IPv4 шлюз по умолчанию может настраиваться посредством DHCP, на хостах IPv6 также посредством DHCP либо через NDP запрос к машрутизатору.
- На маршрутизаторе аналог шлюза по умолчанию - маршрут последней надежды (DGW) определяет, по какому маршруту слать пакет, если он не подходит ни под одно правило маршрутизации.

Маршрут по умолчанию обозначается в таблице маршрутизации следующим образом **0.0.0.0 netmask 0.0.0.0** (наложение такой маски на любой адрес даст значение 0.0.0.0, то есть это правило выполняется для любого адреса) и выполняется последним после всех остальных правил (если они есть).

### Типы маршрутов на маршрутизаторе

- Прямого подключения - машрут автоматически добавляется, если интерфейс, на котором настроен IP адрес, входящий в эту сеть, активен.
- Удаленные маршруты - маршруты, не имеющие прямого подключения, но которые могут быть добавлены:
- Статически (вручную)
- Динамически (через обмен данными с другими маршрутизаторами по опредленному протоколу динамической маршрутизации)
- Маршрут последней надежды - маршрут, определяющий, по какому маршруту слать пакет, если он не подходит ни под одно другое правило маршрутизации.
- Если машрут последней надежды не настроен, то если не найдено подходящее правило для персылки пакета, он будет отброшен, а по протоколу ICMP отправителю будет отправлено диагностическое сообщение?

### Статическая и динамическая маршрутизация

Статическая маршрутизация:

- настраивается вручную
- при изменении топологии необходимо перенастроить статические маршруты
- максимальная безопасность

,,,
ip route 10.1.1.0 255.255.255.0 209.165.200.226
,,,

Динамическая маршрутизация:

- Автоматическое обнаружение удаленных сетей
- Обновление данных маршрутизации при изменении топологии
- Поиск оптимальных маршрутов при изменении топологии
- уменьшенная безопасность

Пример списка маршрутов на маршрутизаторе:

,,,
show ip route
,,,

Вывод:
- L: адрес локального интерфейса с прямым подключением
- C: присоединенная напрямую сеть
- S: статический маршрут, вручную настроенный администратором
- O: OSPF
- D: EIGRP
- *: звездочкой показывается маршрут последней надежды (кандидат)

Вопрос: что значит запись в выводе ***is variably subnetted***









