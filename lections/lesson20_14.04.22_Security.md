## Угрозы безопасности уровня L2.

### Категории атак на безопасность сетевого уровня L2:
1. Атака на таблицу МАС - атака переполнения таблицы CAM коммутатора.
2. Атаки на сети VLAN - атаки на устройства в нативной VLAN и атаки с использованием двойного тегирования VLAN.
3. Атаки на DHCP - атаки на истощение ресурсов DHCP.
4. Атаки на протокол ARP - атаки подмены ARP и "отравление" кеша ARP.
5. Атаки с подменой адреса - атаки подмены MAC и IP адресов.
6. Атаки протокола STP - атаки путем манипуляции протокола.
7. Разведывательные атаки на CDP.

### Атака на таблицу МАС

Таблицы MAC-адресов коммутаторов имеют фиксированный размер. Злоумышленник c помощью инструмента генерации фиктивных MAC-адресов (например macof) отправляет фиктивные MAC-адреса источника до тех пор, пока таблица МАС-адресов коммутатора не заполнится. Когда это происходит, коммутатор обрабатывает кадр как неизвестную одноадресную рассылку и начинает пересылать весь входящий трафик из всех портов в той же VLAN без учета таблицы MAC. Это условие теперь позволяет атакующему захватить все кадры, отправленные с одного хоста на другой в локальной сети или локальной сети VLAN.
Чтобы нейтрализовать атаки переполнения таблицы MAC-адресов, сетевые администраторы должны включать режим защиты портов (Port security). Защита порта позволит узнать только определенное количество исходных MAC-адресов порта.

### Атаки на сети VLAN

#### Атака VLAN Hopping

Атака использует функцию автоматического согласования транковых портов, включенную по умолчанию на портах коммутатора. 
Эту атаку можно провести, например с помощью утилиты Yersinia, входящей в стостав Kali Linux. 

Для борьбы с атакой необходимо отключить автосогласование портов.

#### Атака VLAN с помощью двойного тегирования.

Атака использует внедрение в кадр ethernet дополнительного VLAN тега и использование для внедрения нативной VLAN, известной злоумышленнику. После попадания кадра с двойным тегированием в магистральный порт коммутатора первый тег vlan снимается (так как он нативный) и кадр пересылается далее. Следующий коммутатор считывает уже внутренний тег и рассылает кадр в порты, соответсвующие vlan, указанному во внутреннем теге.

Для борьбы с атакой необходимо отключить автосогласование портов и сделать нативный vlan отличным от 1.

### Атаки на DHCP

#### Атака на истощение DHCP

Цель атаки с истощение DHCP - создать отказ в обслуживании (DoS) для подключения клиентов. Для атаки путем истощения ресурсов DHCP необходим специальный инструмент,например Gobbler. Gobbler способен искать все доступные для аренды IP-адреса и пытается все их арендовать. В частности, он создает сообщения DHCP Discovery с поддельными MAC-адресами.

#### Атака поддельным DHCP (spoofing)

Атака состоит в том, что к сети подключается мошеннический DHCP-сервер и предоставляет ложные параметры настройки IP легитимным клиентам. Подставной сервер может предоставлять различные неправильные сведения: шлюз по умолчанию, DNS-сервер, IP-адрес.

### Атаки на протокол ARP

Атака основана на уязвимости протокола ARP, который не проверяет подлинности ARP-запросов и ARP-ответов. Хост злоумышленника может послать так называемый gratuitous ARP (самообращенный ARP), в котором указывает свой MAC для целевого IP. Все хосты в сегменте, принимая данный ARP, обновляют свои ARP таблицы и начинают пересылать сообщения на хост злоумышленника. Внедрение DAI защищает от атаки.

### Атаки с подменой адреса

Атака основана на предыдущей уязвимости протокола ARP. Злоумышленник изменяет MAC-адрес своего хоста в соответствии с другим известным
MAC-адресом целевого хоста. Коммутатор перезаписывает текущую запись в таблице CAM и назначает MAC-адрес новому порту. Затем он пересылает кадры, предназначенные для целевого хоста, на атакующий хост. Когда целевой хост отправляет трафик, коммутатор исправит ошибку, переназначив MAC-
адрес на исходный порт. Чтобы не дать коммутатору вернуть назначение порта в правильное состояние, злоумышленник может создать программу или сценарий, который будет постоянно отправлять кадры коммутатору, чтобы коммутатор сохранял неверную или поддельную информацию.

### Атаки с использованием STP

Атака основана на уязвимости протокола STP, который не проверяет подлинности сообщений протокола. Злоумышленник может манипулировать протоколом связующего дерева (STP) для проведения атаки путем подмены корневого моста и изменения топологии сети, чтобы затем перенапрвить трафик домена по нужному направлению.
Для проведения атак путем манипуляций STP хост злоумышленника передает широковещательные пакеты BPDU с информацией об изменении конфигурации  и топологии STP, чтобы вызвать перерасчет связующего дерева. Передаваемые хостом злоумышленника пакеты BPDU объявляют о более низком значении приоритета моста для попытки избрания хоста корневым мостом. Эта STP-атака нейтрализуется за счет реализации BPDU Guard на всех портах
доступа.

### Разведывательные атаки на CDP

Протокол Cisco Discovery Protocol (а также его аналог открытый протокол LLDP)  — это проприетарный протокол обнаружения канала уровня 2. Он включен на всех устройствах Cisco по умолчанию. Сетевые администраторы также используют протокол CDP для настройки сетевыхт устройств и для поиска и устранения их неполадок. Информация протокола CDP отправляется через порты с поддержкой CDP в периодических незашифрованных широковещательных рассылках. Данные протокола CDP включают IP-адрес устройства, версию ОС IOS, а также сведения о платформе, возможностях и VLAN с нетегированным трафиком. Устройство, получившее сообщение CDP, обновляет свою базу данных CDP.

## Обеспечение защиты от атак L2

### Выключение неиспользуемых портов коммутатора.

Перейдите к каждому неиспользуемому порту или диапазону портов и выполните команду выключения Cisco IOS shutdown. При необходимости порты можно будет включить позднее.

### Использование функции безопасности порта

#### Включение

Безопасность порта включается с помощью команды настройки интерфейса switchport port-security. Обратите внимание, что команда switchport port-security не может быть настроена при включенном режиме автосогласования транкинга.

```
S1(config)#interace f0/1
S1(config-if)#switchport port-security
```

#### Ограничение разрешенных MAC на порту

Для определения максимального числа MAC адресов, разрешенных для конкретного порта, используется следующая команда:

```
S1(config-if)#switchport port-security maximum <value>
```
По умолчанию это значение равно 1.

#### Назначение разрешенных MAC на порту

Настройка MAC-адреса вручную
```
S1(config-if)#switchport port-security mac-address <mac-address>
```

Динамическое изучение и автоматическая привязка определенного MAC-адреса. Сохранение текущей конфигурации запишет его в нее.
```
S1(config-if)#switchport port-security mac-address sticky
```
*Примечание: по умолчанию при включении режима port-security включается динамическое изучение, но без записи в конфигурацию

#### Настройка устаревания MAC на порту

Информация о защищенных статических или динамических MAC на порту может быть удалена автоматически при достижении ппредельного времени. Есть 2 настройки таймера устаревания: абсолютный - когда защищенные адреса удаляются по истечении указанного времени и по таймеру неактивности - удаляются только, если они неактивны в течении указанного времени.
```
S1(config-if)#switchport port-security aging time 10
S1(config-if)#switchport port-security aging type inactivity 
```

#### Настройка режима реагирования на нарушения MAC

Если MAC-адрес устройства, подключенного к порту, отличается от списка защищенных адресов, происходит нарушение (violation) порта.

```
S1(config-if)#switchport port-security violation {shutdown | restrict | protect}
```
- shutdown (default): Порт немедленно переходит в состояние отключения по ошибке, выключает светодиод порта и отправляет сообщение системного журнала. Для этого режима предусмотрено увеличение значения счётчика нарушений. Когда безопасный порт находится в состоянии отключения по ошибке, администратор должен повторно включить его, введя команды shutdown и no shutdown.

- restrict:  Порт отбрасывает пакеты с неизвестными адресами источника, пока вы не удалите достаточное количество безопасных MAC-адресов, чтобы опуститься ниже максимального значения или увеличить максимальное значение. Этот режим вызывает увеличение счетчика нарушений безопасности и генерирует сообщение системного журнала (syslog).

- protect: Это наименее безопасный из режимов нарушения безопасности. Порт отбрасывает пакеты с неизвестными адресами источника, пока вы не удалите достаточное количество безопасных MAC-адресов, чтобы опуститься ниже максимального значения или увеличить максимальное значение. Сообщения в системный журнал не записываются.

*Примечание: после принудительного выключения порта коммутатором.ю включить его обратно можно последовательностью команд shutdown, no shutdowm.

#### Просмотр настроек port-security

Общие параметры port-security
```
S1(config)#show port-security
```
Параметры port-security на конкретном интерфейсе
```
S1(config)#show port-security interface fa0/18 
```
Просмотр защищенных MAC на портах:
```
S1(config)#show port-security address 
```
### Защита от атак на VLAN.

- Перевод всех несипользуемых портов в режим shutdown
- Перевод всех портов доступа в режим access
- Перевод всех транковых портов в режим trunk
- Установка нативной VLAN, отличной от VLAN1

### Защита от атак на DHCP.

Включение отслеживания атак DHCP командой ip dhcp snooping для всех VLAN или для определнных:

```
S1(config)#ip dhcp snooping vlan 5,10,50-52
```
Назначение доверенных портов без ограничения на сообщения DHCP:
```
S1(config)#interace f0/1
S1(config-if)#ip dhcp snooping trust
```
Назначение недоверенным портам ограничения на скорость приема сообщений DHCP в секунду:
```
S1(config)#interace range f0/5 -24
S1(config-if)#ip dhcp snooping limit rate
```
Просмотр конфигурации dhcp snooping:
```
S1(config)#show ip dhcp snooping
S1(config)#ip dhcp snooping binding
```

### Защита от атак на ARP (DAI).

Динамическая защита ARP (DAI) предотвращяет атаки на ARP путем:
- Запрета ретрансляции недопустимых или незапрошенных ответов ARP на другие порты в той же VLAN.
- Перехват всех ARP-запросов и ответов на ненадежных портах.
- Проверка каждого перехваченного пакета на предмет правильной привязки IP-к-MAC.
- Отключение интерфейса, если настроенное число DAI пакетов ARP превышено.

DAI работает в связке с отслеживанием DHCP (dhcp snooping).

Порядок настройки DAI:
- Включение dhcp snooping
```
S1(config)#ip dhcp snooping vlan 10
```
- Включение режима проверки arp:
```
S1(config)#ip arp inspection vlan 10
```
- Назначение доверенных портов для отлеживания ARP и DHCP (uplink связи с коммутатором или маршрутизатором):
```
S1(config)#interace f0/1
S1(config-if)#ip dhcp snooping trust
S1(config-if)#arp inspection trust
```
- Также можно дополнительно настроить проверку сравнения MAC в заголовке Ethernet на соответствие MAC-адреса в теле ARP и проверку на наличие недопустимых и неожиданных IP-адресов, включая адреса 0.0.0.0, 255.255.255.255 и все IP-адреса многоадресной рассылки. 

```
S1(config)#ip arp inspection validate src-mac dst-mac ip
```

