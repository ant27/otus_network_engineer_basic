## Занятие 6. Разрешение IP адресов. Протоколы ARP и ND.

Дата занятия: 22.03.21

### MAC и IP адрес.

MAC (физический адрес) - используется для обмена данными между сетевыми платами на канальном уровне в пределах локальной (одноранговой, домене широковещания) сети.
IP (логический адрес) - используется для отправки пакетов от узла источника к узлу назначения, которые могут находиться как в одной одноранговой сети, так и в разных. 

#### Формат кадров протокола ARP.

Длина кадра ARP - 42 байта.

- Preamble (Преамбула) (8 байт) - общая для всех ethernet-кадров последовательность, сигнализирующая другим абонентам, что абонент готовится начать передачу. 
- Destination address (MAC-Адрес назначения) (6 байт, 48 бит)
- Source address (MAC-Адрес источника) (6 байт, 48 бит)
- Frame type (Тип кадра) (2 байта, 16 бит) - Спецификатор типа кадров. Поле, указывающее, данные какого типа содержатся в блоке данных кадра. Для ARP запроса или ARP отклика это поле содержит 0x0806.
- Data (блок данных) (до 1500 байт) - в случае ARP в этом блоке содержится 28 байт сообщения протокола  ARP:
1. Hard type (тип аппаратного адреса) (2 байта, 16 бит) - так протокол IP предусматривал работу со многими распространенными на тот момент протоколами канального уровня, была необходимость указывать тип адреса на канальном уровне. Для Ethernet это значение равно единице
2. Prot type (тип адреса сетевого протокола) (2 байта, 16 бит)- Аналогично, так как ethernet предусматривал работу со многими распространенными на тот момент протоколами сетевого уровня, была необходимость указывать тип адреса на сетевом уровне. Для IP это значение равно 0x0800.
3. Hard size (размер аппаратного адреса) - размеры в байтах аппаратного адреса. 6 для Ethernet.
4. Prot size (размер адреса сетевого протокола) - размеры в байтах адреса сетевого протокола. 4 для IP адреса.
5. Op (тип операции) - ARP запрос (значение устанавливается в 1), ARP отклик (2), RARP запрос (3) и RARP отклик (4). Это поле необходимо, так как поля типа фрейма (frame type) одинаковы для ARP запроса и ARP отклика.
6. Sender hardware address (SHA) (аппаратный адрес отправителя) - MAC адрес отправителя для Ethernet.
7. Sender protocol address (SPA) - IP-адрес отправителя для IP.
8. Target hardware address (THA) (аппаратный адрес получателя) - MAC адрес получателя для Ethernet.
9. Sender protocol address (SPA) - IP-адрес получателя для IP.
- FCS (frame check sequence) – общее для всех ethernet-кадров поле контрольной суммы.
- Trailer - общее для всех ethernet-кадров поле окончания ethernet кадра. 

#### Порядок формирования запросных и ответных кадров протокола ARP.

1. При включении сетевого интерфейса с настроенным IP адресом или перенастройки IP адреса на интерфейсе сетевой интерфейс отсылает добровольный (gratuitous) ARP-запрос - оповещение оо своем MAC и IP адресах. Значения полей в таком ARP кадре будут следующие:
- Destination address (MAC-Адрес назначения) - FF.FF.FF.FF.FF.FF (широковещательный MAC-адрес)
- Source address (MAC-Адрес источника) - собственный MAC-адрес интерфейса
- Op (тип операции) - 1 (ARP запрос)
- Sender hardware address (SHA) (аппаратный адрес отправителя) - собственный MAC-адрес интерфейса.
- Sender protocol address (SPA) - собственный IP-адрес, настроенный на интерфейсе.
- Target hardware address (THA) (аппаратный адрес получателя) - FF.FF.FF.FF.FF.FF (широковещательный MAC-адрес)
- Target protocol address (TPA) - собственный IP-адрес, настроенный на интерфейсе.
- 
*Примечание - проверить, точно ли происходит отправка gratuitous ARP при физическом отключении и обратном включении уже настроенного интерфейса.

При получении этого запроса узлы не отвечают на него, но делают в свой arp-кэш запись с даннными соответсвия MAC и IP адреса.

Данный запрос также используется для обнаружения конфликта IP-адресов. Если при получении такого запроса узел обнаруживает, что на нем настроен такой же IP, который указан в запросе он отправляет атакующему (offending) узлу (узлу, отправившему gratuitous ARP) ответ со следующими полями: 

- Destination address (MAC-Адрес назначения) - FF.FF.FF.FF.FF.FF (широковещательный MAC-адрес)
- Source address (MAC-Адрес источника) - собственный MAC-адрес интерфейса
- Op (тип операции) - 2 (ARP ответ)
- Sender hardware address (SHA) (аппаратный адрес отправителя) - собственный MAC-адрес интерфейса.
- Sender protocol address (SPA) - собственный IP-адрес, настроенный на интерфейсе.
- Target hardware address (THA) (аппаратный адрес получателя) - FF.FF.FF.FF.FF.FF (широковещательный MAC-адрес)
- Target protocol address (TPA) - собственный IP-адрес, настроенный на интерфейсе.

При получении ответа на Gratuitous запрос на атакующем узле инициализация адреса сбрасывается (т.е. узел не присвоит интерфейсу конфликтующий адрес). Об этом будет записано в системном журнале, ну и на экране появится ошибка.
Атакуемый узел также зарегистрирует в журнале событий обнаружение конфликта и пользователю будет выдана ошибка. При этом, атакуемый узел не сбросит с себя конфликтный IP-адрес (что сделает Атакующий узел).

Так как по правилам работы ARP-протокола после отправки добровольного запроса  остальные клиенты сегмента обновят свои записи в ARP кэше на схему: [Конфликтующий IP адрес:MAC атакующего узла]. 

Поэтому в конце для исправления этой ситуации атакуемый узел отправляет в сеть свой gratuitous ARP. Этим запросом атакуемый узел обратно исправляет записи в кэшах ARP остальных машин в сегменте на правильные значения. Но на этот запрос уже никто не ответит, т.к. изначально Атакующий узел к этому времени снимет с себя конфликтный IP-адрес.


1. Если на сетевом интерфейсе настроены маршруты в таблице маршрутизации или шлюз по умолчанию в ARP-кеше узла (таблице соответствия ARP) не содержатся данные о них, интерфейс отсылает ARP-запрос о разрешении этих IP адресов для того, чтобы быть готовым к пересылке данных на адреса вне сети. Значения полей в таком ARP кадре будут следующие:
- Destination address (MAC-Адрес назначения) - FF.FF.FF.FF.FF.FF (широковещательный MAC-адрес)
- Source address (MAC-Адрес источника) - собственный MAC-адрес интерфейса
- Op (тип операции) - 1 (ARP запрос)
- Sender hardware address (SHA) (аппаратный адрес отправителя) - собственный MAC-адрес интерфейса.
- Sender protocol address (SPA) - IP-адрес, который необходимо разрешить
- Target hardware address (THA) (аппаратный адрес получателя) - 0.0.0.0.0.0 (нулевой MAC-адрес)
- Target protocol address (SPA) - 0.0.0.0 (нулевой IP-адрес)

2. Если узел определил, что IP-адрес, который необходимо разрешить, это его IP-адрес, он отправляет unicast ответ со следующими полями:

- Destination address (MAC-Адрес назначения) -  MAC-адрес отправителя запроса
- Source address (MAC-Адрес источника) - собственный MAC-адрес интерфейса
- Op (тип операции) - 2 (ARP ответ)
- Sender hardware address (SHA) (аппаратный адрес отправителя) - собственный MAC-адрес интерфейса.
- Sender protocol address (SPA) - собственный IP-адрес
- Target hardware address (THA) (аппаратный адрес получателя) - MAC-адрес отправителя запроса
- Target protocol address (SPA) - IP-адрес отправителя запроса
 
Одновременно с этим он делает в ARP-кэше запись об отправителе запроса. Отправитель запроса, получив ответ, также делает запись в ARP-кэше об отправителе ответа.

#### Порядок использования таблицы маршрутизации узла для формирования кадров протокола ARP.

Пусть отправитель A и получатель B имеют свои адреса с указанием маски подсети.

- Если адреса находятся в одной подсети, то вызывается протокол ARP и определяется физический адрес получателя, после чего IP-пакет инкапсулируется в кадр канального уровня и отправляется по указанному физическому адресу, соответствующему IP-адресу назначения.
- Если нет – начинается просмотр таблицы в поисках прямого маршрута.
- Если маршрут найден, то вызывается протокол ARP и определяется физический адрес соответствующего маршрутизатора, после чего пакет инкапсулируется в кадр канального уровня и отправляется по указанному физическому адресу.
- В противном случае, вызывается протокол ARP и определяется физический адрес маршрутизатора по умолчанию, после чего пакет инкапсулируется в кадр канального уровня и отправляется по указанному физическому адресу.

#### Разрешение IP-адресов в IPv6

дополнить
