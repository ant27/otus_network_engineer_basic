## Занятие 12. Технология VLAN, маршрутизация в VLAN.

Дата занятия: 12.04.21

### Определение технологии VLAN.

VLAN - это дополнение протокола канального уровня (Ethernet) для логического разделения физической сети на изолированные виртуальные. По сути - это внедрение в кадр ethernet поля с номером VLAN, которое может добавляться, сниматься и анализироваться сетевым оборудованием, поддерживающим технологию VLAN - IEEE 802.1q.

### Можно ли обойтись без VLAN?

В самом деле - можно ли разделить физическую  ethernet сеть на изолированные логические подсети без применения технологии VLAN? На чистом канальном уровне - нет, но, так, как на данный момент ethernet практически всегда идет в связке с протоколом IP, то с его использованием можно. Необходимо настроить на узлах сети, которые мы хотим изолировать друг от друга разные IP подсети. Таким образом они будут на канальном уровне находиться в одной сети, но логически в разных, так как сетевые интерфейсы отбрасывают IP пакеты, которые не предназначены им.

Однако, хоть такие узлы и изолированы друг от друга механизмом работы протокола IP, но они не изолированы от широковещательного траффика друг друга. Также страдает безопасность, так как злоумышленник, имеющий доступ к сети, может подключиться в любую подсеть, настроив нужный IP на своем хосте.  

### Преимущества VLAN.

- Экономия сетевых ресурсов
- Изоляция (сегментация) различных групп устройств на одном сетевом оборудовании
- Ограничение широковещательных, многоадресных и одноадресных передач в каждом отдельном VLAN.

### Типы сетей VLAN.

- ***default*** - VLAN по умолчанию. Всегда имеет номер 1. Его нельзя удалить или переименовать.
- ***native*** - VLAN для нетегиированного траффика от устаревших устройств. По умолчанию совпадает с default, но его номер можно изменить.
- ***1002 - 1005*** - VLAN, зарезервированные для устаревших протоколов. 
- ***voice*** - VLAN, выделенная специально для голосового траффика. Особенность этой VLAN в том, что ее можно настраивать на интерфейсе коммутатора одновременно с другим VLAN (в общем случае один интерфейс можно включить только в один VLAN), а также в том, что траффику в этом VLAN дается высокий приоритет обслуживания. 

### Магистральные (транковые) порты.

Для обеспечения сетевой связности коммутаторов, на которых настроны несколько VLAN, можно соединить между этими коммутаторами по каждому одному порту, настроеному в каждом VLAN. Тогда связность каждого VLAN будет обеспечена, но это приведет к неоправданному расходу сетевых портов и кабелей. Поэтому была придумана технология магистральных портов, которые сами по себе не принадлежат ни к одному VLAN, но передают траффик нескольких (или всех) VLAN между коммутаторами.

### Тегирование кадров Ethernet для идентификации VLAN.

Поле идентификатора VLAN внедряется после поля Src MAC и состоит:

- TPID (16 бит) - идентификатор протокола тегов (для VLAN 0x8100) 
- Pri (3 бит) - приоритет CoS (7 уровней)
- CFI (1 бит) - идентификатор кадров token ring
- VID (12 бит) - идентификатор VLAN (до 4096 VLAN). У провайдеров используется технология двойного тегирования для получения 4096^2 VLAN.

### Номера VLAN стандартного и расширенного диапазона.

- Нормальный диапазон VLAN: 1-1005. Хранятся в файле ***vlan.dat*** во flash-памяти коммутатора.
- Расширенный диапазон VLAN: 1006 - 4096. Хранятся в файле текущей конфигурации ***Running-Config***.

Протокол ***VTP*** распостраняет данные о VLAN на все подчиненные коммутаторы. Он может быть опасен тем, что может перезаписать неправильные данные на сетевое оборудование.

### Команды для работы с VLAN

- Обьявление нового VLAN на коммутаторе

```
Switch> enable
Switch#configure terminal
Switch(config)#vlan vlan-id
Switch(config-vlan)#name vlan-name
Switch(config-vlan)#end
```
*Примечание: при вводе команды ***no vlan vlan-id*** VLAN удаляется. Все порты, которые были ему назначены, ***не*** переходят в VLAN по умолчанию. Поэтому перед удалением VLAN все назначенные ему порты следует вывести из него.

- Добавление интерфейса коммутатора в VLAN

```
Switch(config)#inteface interface-id
Switch(config-if)#switchport mode access
Switch(config-if)#switchport access vlan vlan-id
Switch(config-if)#end
```  
*Примечание: при вводе команды ***no switchport access vlan vlan-id*** интерфейс помещается в VLAN по умолчанию, то есть 1-ый. Команда ***switchport mode access*** переводит порт в режим ***access***. Порт коммутатора может находится в 3-х режимах - auto, access, trunk. Режим Auto означает, что, если на подключенном к этому интерфейсу интерфейсе настроят trunk, то этот интерфейс также автоматически перейдет в trunk. Это небезопасно и рекомендуется вручную указывать режим работы порта.

- Назначение интерфейса коммутатора магистральным портом

```
Switch(config)#inteface interface-id
Switch(config-if)#switchport mode trunk
Switch(config-if)#switchport trunk allowed vlan vlan-list
Switch(config-if)#switchport trunk allowed vlan add vlan-id
Switch(config-if)#switchport trunk native vlan vlan-id
Switch(config-if)#end
```  
*Примечание: команда ***switchport trunk allowed vlan vlan-list*** настраивает список vlan, которым разрешен доступ в магитстраль. По умолчанию всем VLAN разрешен доступ к настроенному транковому порту. Однако, если на коммутаторе не созданы VLAN, траффик которых он передает по своим настроенным транковым портам, он будет такой траффик ***удалять***. То есть на всех коммутаторах сети с VLAN должны быть прописаны все используемые VLAN. Команда ***switchport trunk native vlan vlan-id*** задает native vlan для данного интерфейса.

- Команды просмотра информации о настроенных VLAN

```
Switch#show vlan
Switch#show interfaces interfac-id switchport
```  

### Маршрутизация между VLAN

Так как узлы в VLAN логически изолированы и представляют собой как будто разные физические сети, то взаимодействие между узлами не может происходить без использования маршрутизатора или коммутатора уровня L3.

Есть 3 варианта маршрутизации между VLAN:
- Физическое подключение интерфейсов каждого VLAN к портам маршрутизатора и его настройка. Очень неэффективное использование сетевых ресурсов. Не применяется.
- Маршрутизатор на палке (router-on-a-stick) - настройка транкового порта на коммутаторе с VLAN и подинтерфейсов на маршрутизаторе.
- Коммутатор уровня 3 - в каждом VLAN настраиваются виртуальные интерфейсы SVI. Между интерфейсами настраивается маршрутизация между VLAN. 

- Настройка подинтерфейсов маршрутизатора

```
Switch(config)#inteface interface-id
Switch(config-if)#switchport mode trunk
Switch(config-if)#switchport trunk allowed vlan vlan-list
Switch(config-if)#switchport trunk allowed vlan add vlan-id
Switch(config-if)#switchport trunk native vlan vlan-id
Switch(config-if)#end
```  
