## Принципы маршрутизации. Статическая маршрутизация

Существуют 2 функции маршрутизатора: выбор наилучшего маршрута для пересылки пакетов и сама пересылка.
РАссмотрим вопрос выбора наилучшего маршрута.

### Выбор наилучшего маршрута

Наилучший путь для маршрутизатора - это путь, дающий в таблице маршрутизации самое длинное совпадение с адресом назначения.

Для примера возьмем пакет IPv4 имеет с адресом назначения IPv4 172.16.0.10. Маршрутизатору доступно три возможных маршрута, совпадающих с этим пакетом — 172.16.0.0/12, 172.16.0.0/18 и 172.16.0.0/26. Маршрут 172.16.0.0/26 имеет самое длинное совпадение, поэтому для пересылки пакета выбирается именно этот маршрут. Для того, чтобы эти маршруты рассматривались как совпадающие, необходимо минимальное количество совпадающих битов, указанное маской подсети маршрута.

172.16.0.10     **10101100.00010000.000000000000.00001010**

172.16.0.0/12  **10101100.0001**00000000000000.00001010

172.16.0.0/18  **10101100.00010000.00**000000.00001010

172.16.0.0/26  **10101100.00010000.00000000.00**001010

### Построение таблицы маршрутизации

1. Непосредственно подключенная сеть добавляется в таблицу маршрутизации, когда интерфейс настроен с IP-адресом и маской подсети (длина префикса) и активен (up и up).
2. Удаленные сети:сети, не подключенные напрямую к маршрутизатору. Маршрутизатор получает сведения об удаленных сетях двумя способами:
- Статические маршруты - добавляются в таблицу маршрутизации, когда маршрут настраивается вручную.
- Протоколы динамической маршрутизации - добавляются в таблицу маршрутизации, когда протоколы маршрутизации динамически узнают о удаленной сети.
- Маршрут по умолчанию: определяет маршрутизатор следующего перехода, который будет использоваться, если таблица маршрутизации не содержит определенного маршрута, соответствующего IP-адресу назначения. Маршрут по умолчанию может быть введен вручную как статический маршрут или автоматически изучен через протокол динамической маршрутизации. Маршрут по умолчанию имеет длину префикса /0. Длина префикса /0 указывает на то, что нет битов, которые должны соответствовать IP-адресу назначения для этого маршрута. Если нет маршрутов с совпадением длиннее 0 бит, для пересылки пакета используется маршрут по умолчанию.
- Если маршрут по умолчанию не задан - пакет отбрасывется.

### Процесс принятия решения о переадресации пакетов

1. Если запись маршрута указывает, что выходный интерфейс является напрямую подключенной сетью, пакет перенаправляется непосредственно на
устройство назначения. Обычно это Ethernet LAN. Для определения MAC адреса устройства назначения используется протокол ARP и ICMPv6 Neighbor
Discovery.
2. Если запись маршрута указывает, что выходный интерфейс является удаленной сетью, маршрутизатор будет искать IP-адрес маршрутизатора следующего прыжка в таблице ARP или в соседнем кэше вместо IP-адреса назначения пакета.
3. Если маршрут по не найден - пакет отбрасывется.

### Источники маршрутов в выводе команды show ip route
Команда show ip route выводит таблицу маршрутизации устройства. Источник для каждого маршрута в таблице маршрутизации идентифицируется кодом. К числу распространенных кодов относятся следующие:
- L - указывает адрес, назначенный интерфейсу маршрутизатора (локальный маршрут непосрественно к интерфейсу маршрутизатора). 
- C - определяет сеть с прямым подключением.
- S - определяет статический маршрут, созданный для достижения конкретной сети.
- O - определяет сеть, динамически полученную от другого маршрутизатора с
помощью протокола маршрутизатора OSPF.
- *\ - маршрут является кандидатом на маршрут по умолчанию

### Структура строки маршрута в выводе команды show ip route

L 10.0.4.0/24 110/50 via 10.0.0.3 00:13:29 Serial10/1/1

1      2       3  4        5          6         7          

1. Источник маршрута — определяет, каким способом был получен маршрут.
2. Сеть назначения (длина префикса и префикса) — определяет адрес удаленной сети. 
3. Административная дистанция — определение надежности источника маршрута. Низкие значения указывают на предпочтительный источник маршрута.
4. Метрика — определяет значения, назначенные для доступа к удаленной сети. Предпочтительные маршруты имеют низкие значения.
5. Следующий переход — определение IPv4-адреса следующего маршрутизатора, на который следует переслать пакет.
6. Временная метка маршрута — определение количества времени, прошедшего с тех пор, как был получен маршрут.
7. Выходной интерфейс — определяет выходной интерфейс для отправки пакета к конечному пункту назначения.

### Структура команды настройки статического маршрута

```
R1(config)#ip route 10.0.4.0 255.255.255.0 10.0.3.2
```
где,
- 10.0.4.0 - сеть для достижения данным маршрутом
- 255.255.255.0 - маска сети
- 10.0.3.2 - адрес маршрутизатора, в который нужно отправлять пакеты для достижения сети.


### Административное расстояние

Запись маршрута для определенного сетевого адреса (префикса и длины префикса) может отображаться только один раз в таблице маршрутизации. Однако возможно, что таблица маршрутизации узнает об одном и том же сетевом адресе из нескольких источников маршрутизации. Каждый протокол маршрутизации может выбирать свой путь для достижения пункта назначения на основе метрики этого протокола маршрутизации.
Протоколы маршрутизации определяют оптимальный путь или маршрут к каждой сети. Затем маршрут сверяется с таблицей маршрутизации. Этот маршрут будет добавлен в таблицу маршрутизации, если в таблице нет другого источника маршрутизации с меньшим административным расстоянием.


### Пример настройки статического маршрута
```
R1(config)# ip route 172.16.1.0 255.255.255.0 s0/1/0
R1(config)# ip route 192.168.1.0 255.255.255.0 s0/1/0
R1(config)# ip route 192.168.2.0 255.255.255.0 s0/1/0
```
### Пример настройки статического маршрута по умолчанию
```
R1(config)# ip route 0.0.0.0 0.0.0.0 172.16.2.2
```
### Команды вывода списка маршрутов маршрутизатора

- show ip route static
- show ip route network
- show running-config | section ip route

### Плавающие статические маршруты

Плавающие статические маршруты — это статические маршруты, используемые для предоставления резервного пути основному статическому маршруту или динамическому маршруту. Плавающий статический маршрут используется только тогда, когда основной маршрут недоступен. Для этой цели плавающий статический маршрут настраивается с более высоким значением административного расстояния, чем основной маршрут. Административное расстояние определяет надежность маршрута. При наличии нескольких путей к адресу назначения маршрутизатор выбирает путь с самым низким значением административного расстояния. По умолчанию статические маршруты имеют значение административного расстояния, равное 1, поэтому они имеют приоритет перед маршрутами, полученными от протоколов динамической маршрутизации.

Пример настройки плавающих маршрутов:

```
R1(config)# ip route 0.0.0.0 0.0.0.0 172.16.2.2
R1(config)# ip route 0.0.0.0 0.0.0.0 10.10.10.2 5
R1(config)# ipv6 route ::/0 2001:db8:acad:2::2
R1(config)# ipv6 route ::/0 2001:db8:feed:10::2 5
```
### Маршруты хостов

Маршрут хоста представляет собой адрес IPv4 с 32-разрядной маской или адрес IPv6 с 128-разрядной маской. Это маршрут до конкретного узла сети,например, сервера, а не к целой сети.

Пример настройки маршрута до хоста:
``
Branch(config)# ip route 209.165.200.238 255.255.255.255 198.51.100.2
Branch(config)# ipv6 route 2001:db8:acad:2::238/128 2001:db8:acad:1::2
``
